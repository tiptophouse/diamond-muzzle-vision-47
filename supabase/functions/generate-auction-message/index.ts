import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { corsHeaders } from '../_shared/cors.ts';

const LOVABLE_API_KEY = Deno.env.get('LOVABLE_API_KEY');

interface DiamondData {
  shape: string;
  weight: number;
  color: string;
  clarity: string;
  cut: string;
  stock_number: string;
  price_per_carat?: number;
}

interface GenerateMessageRequest {
  diamond: DiamondData;
  start_price: number;
  min_increment: number;
  hours_remaining: number;
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { diamond, start_price, min_increment, hours_remaining }: GenerateMessageRequest = await req.json();

    console.log('ğŸ¤– Generating auction message for:', diamond.stock_number);

    if (!LOVABLE_API_KEY) {
      throw new Error('LOVABLE_API_KEY not configured');
    }

    // Build prompt for AI
    const prompt = `×›×ª×•×‘ ×”×•×“×¢×ª ××›×™×¨×” ×¤×•××‘×™×ª ××§×¦×•×¢×™×ª ×‘×¢×‘×¨×™×ª ×œ×™×”×œ×•× ×¢× ×”×¤×¨×˜×™× ×”×‘××™×:
- ×¦×•×¨×”: ${diamond.shape}
- ××©×§×œ: ${diamond.weight} ×§×¨××˜
- ×¦×‘×¢: ${diamond.color}
- × ×™×§×™×•×Ÿ: ${diamond.clarity}
- ×—×™×ª×•×š: ${diamond.cut}
- ××¡×¤×¨ ××œ××™: ${diamond.stock_number}

××—×™×¨ ×¤×ª×™×—×”: $${start_price.toLocaleString()}
×”×¤×¨×© ××™× ×™××œ×™ ×œ×”×¦×¢×”: $${min_increment}
×–××Ÿ × ×•×ª×¨: ${hours_remaining} ×©×¢×•×ª

×”×”×•×“×¢×” ×¦×¨×™×›×” ×œ×”×™×•×ª:
1. ×§×¦×¨×” ×•××¨×©×™××” (2-3 ×©×•×¨×•×ª ×‘×œ×‘×“)
2. ×›×•×œ×œ×ª ×××•×’'×™ ×¨×œ×•×•× ×˜×™×™×
3. ×™×•×¦×¨×ª ×“×—×™×¤×•×ª ×•×¢× ×™×™×Ÿ
4. ×¤×¨×•×¤×¡×™×•× ×œ×™×ª ××š ××–××™× ×”

×“×•×’××” ×œ×¡×’× ×•×Ÿ: "ğŸ”¨ ××›×¨×– ×¤×¢×™×œ - ×™×”×œ×•× ×™×•×§×¨×ª×™! ğŸ’ 1.50ct ROUND BRILLIANT | G ×¦×‘×¢ â€¢ VS1 × ×™×§×™×•×Ÿ â€¢ Excellent ×—×™×ª×•×š | ××—×™×¨ ×¤×ª×™×—×”: $5,000 | ×”×¦×¢×” ×”×‘××”: +$100 | â° × ×’××¨ ×‘×¢×•×“ 24 ×©×¢×•×ª"`;

    // Call Lovable AI Gateway with gemini-2.5-flash
    const response = await fetch('https://ai.gateway.lovable.dev/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${LOVABLE_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'google/gemini-2.5-flash',
        messages: [
          { role: 'system', content: '××ª×” ××•××—×” ×œ×©×™×•×•×§ ×™×”×œ×•××™× ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×”×•×“×¢×•×ª ××›×™×¨×” ×¤×•××‘×™×ª ×§×¦×¨×•×ª, ××¨×©×™××•×ª ×•×™×¢×™×œ×•×ª.' },
          { role: 'user', content: prompt }
        ],
        max_tokens: 200,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('AI Gateway error:', response.status, errorText);
      
      // Fallback to template if AI fails
      const fallbackMessage = `ğŸ”¨ ××›×¨×– ×¤×¢×™×œ - ×™×”×œ×•× ×™×•×§×¨×ª×™!

ğŸ’ ${diamond.weight}ct ${diamond.shape}
ğŸ¨ ${diamond.color} ×¦×‘×¢ â€¢ ${diamond.clarity} × ×™×§×™×•×Ÿ â€¢ ${diamond.cut} ×—×™×ª×•×š

ğŸ’° ××—×™×¨ ×¤×ª×™×—×”: $${start_price.toLocaleString()}
ğŸ“ˆ ×”×¦×¢×” ×”×‘××”: +$${min_increment}
â° × ×’××¨ ×‘×¢×•×“: ${hours_remaining} ×©×¢×•×ª

âœ¨ ××œ ×ª×¤×¡×¤×¡×• ××ª ×”×”×–×“×× ×•×ª!`;

      return new Response(
        JSON.stringify({ 
          success: true, 
          message: fallbackMessage,
          used_fallback: true 
        }),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' },
          status: 200 
        }
      );
    }

    const data = await response.json();
    const aiMessage = data.choices?.[0]?.message?.content;

    if (!aiMessage) {
      throw new Error('No message generated by AI');
    }

    console.log('âœ… AI message generated successfully');

    return new Response(
      JSON.stringify({ 
        success: true, 
        message: aiMessage.trim(),
        used_fallback: false 
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200 
      }
    );
  } catch (error) {
    console.error('âŒ Error generating auction message:', error);
    return new Response(
      JSON.stringify({ 
        error: error instanceof Error ? error.message : 'Failed to generate message' 
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 500 
      }
    );
  }
});
