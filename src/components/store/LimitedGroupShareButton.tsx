import { Share, AlertTriangle, Users, Sparkles, Camera, ImageIcon } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Badge } from "@/components/ui/badge";
import { useState } from "react";
import { useShareQuota } from "@/hooks/useShareQuota";
import { useSecureDiamondSharing } from "@/hooks/useSecureDiamondSharing";
import { useTelegramHapticFeedback } from "@/hooks/useTelegramHapticFeedback";
import { useTelegramMainButton } from "@/hooks/useTelegramMainButton";
import { useIsAdmin } from '@/hooks/useIsAdmin';
import { Diamond } from "@/components/inventory/InventoryTable";
import { useTelegramWebApp } from "@/hooks/useTelegramWebApp";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "@/hooks/use-toast";

interface LimitedGroupShareButtonProps {
  diamond: Diamond;
  className?: string;
  variant?: "default" | "outline" | "ghost" | "secondary";
  size?: "default" | "sm" | "lg";
}

export function LimitedGroupShareButton({ 
  diamond, 
  className = "", 
  variant = "default", 
  size = "default" 
}: LimitedGroupShareButtonProps) {
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const { quotaData, loading, useShare } = useShareQuota();
  const { shareWithInlineButtons } = useSecureDiamondSharing();
  const { impactOccurred, notificationOccurred } = useTelegramHapticFeedback();
  const { isAdmin } = useIsAdmin();
  const { user } = useTelegramWebApp();

  const handleShareClick = () => {
    console.log('üîç SHARE CLICK DEBUG: Button clicked, isAdmin:', isAdmin, 'quotaData:', quotaData);
    impactOccurred('light');
    
    // Admin users bypass quota checks entirely
    if (isAdmin) {
      console.log('üîß SHARE CLICK DEBUG: Admin bypass - opening dialog');
      setShowConfirmDialog(true);
      return;
    }
    
    if (!quotaData || quotaData.sharesRemaining <= 0) {
      console.error('‚ùå SHARE CLICK DEBUG: No shares remaining');
      notificationOccurred('error');
      return;
    }
    setShowConfirmDialog(true);
  };

  const handleTestShare = async () => {
    console.log('üß™ TEST SHARE: Sending test message to personal chat');
    impactOccurred('medium');
    
    try {
      // Show loading state
      toast({
        title: "◊©◊ï◊ú◊ó ◊î◊ï◊ì◊¢◊™ ◊ë◊ì◊ô◊ß◊î...",
        description: "◊û◊¢◊ë◊ì ◊ê◊™ ◊î◊ë◊ß◊©◊î",
      });

      // Send test message to personal chat instead of group
      const { data, error } = await supabase.functions.invoke('send-diamond-to-group', {
        body: {
          diamond: {
            id: diamond.id,
            stockNumber: diamond.stockNumber,
            carat: diamond.carat,
            shape: diamond.shape,
            color: diamond.color,
            clarity: diamond.clarity,
            cut: diamond.cut,
            price: diamond.price,
            imageUrl: diamond.imageUrl,
            gem360Url: diamond.gem360Url
          },
          sharedBy: user?.id,
          testMode: true // This will send to personal chat instead of group
        }
      });

      if (error) {
        console.error('‚ùå TEST SHARE: Error:', error);
        impactOccurred('heavy');
        toast({
          title: "◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊ï◊ì◊¢◊™ ◊ë◊ì◊ô◊ß◊î",
          description: error.message || "◊ê◊ô◊®◊¢◊î ◊©◊í◊ô◊ê◊î ◊ú◊ê ◊¶◊§◊ï◊ô◊î",
          variant: "destructive"
        });
        return;
      }

      console.log('‚úÖ TEST SHARE: Test message sent successfully');
      impactOccurred('light');
      toast({
        title: "‚úÖ ◊î◊ï◊ì◊¢◊™ ◊ë◊ì◊ô◊ß◊î ◊†◊©◊ú◊ó◊î ◊ë◊î◊¶◊ú◊ó◊î!",
        description: "◊ë◊ì◊ï◊ß ◊ê◊™ ◊î◊¶'◊ê◊ò ◊î◊ê◊ô◊©◊ô ◊©◊ú◊ö ◊ë◊ò◊ú◊í◊®◊ù ◊ú◊¶◊§◊ô◊ô◊î ◊ë◊î◊ï◊ì◊¢◊î",
      });
      
      setShowConfirmDialog(false);
    } catch (error) {
      console.error('‚ùå TEST SHARE: Failed:', error);
      impactOccurred('heavy');
      toast({
        title: "◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊ï◊ì◊¢◊™ ◊ë◊ì◊ô◊ß◊î",
        description: "◊ê◊ô◊®◊¢◊î ◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊î◊ï◊ì◊¢◊î",
        variant: "destructive"
      });
    }
  };

  const handleConfirmShare = async () => {
    console.log('üîç SHARE DEBUG: Share button clicked for diamond:', diamond.stockNumber);
    console.log('üîç SHARE DEBUG: Current quota data:', quotaData);
    impactOccurred('medium');
    
    try {
      // Show loading state
      toast({
        title: "◊©◊ï◊ú◊ó ◊ô◊î◊ú◊ï◊ù ◊ú◊ß◊ë◊ï◊¶◊î...",
        description: "◊û◊¢◊ë◊ì ◊ê◊™ ◊î◊ë◊ß◊©◊î",
      });

      // First use the share quota
      console.log('üîç SHARE DEBUG: Attempting to use share quota...');
      const success = await useShare(diamond.stockNumber);
      console.log('üîç SHARE DEBUG: Share quota result:', success);
      
      if (success) {
        console.log('üîç SHARE DEBUG: Quota used successfully, now sharing diamond...');
        // Then share the diamond
        const shared = await shareWithInlineButtons(diamond);
        console.log('üîç SHARE DEBUG: Diamond sharing result:', shared);
        
        if (shared) {
          console.log('‚úÖ SHARE DEBUG: Complete share process successful');
          impactOccurred('light');
          toast({
            title: "‚úÖ ◊ô◊î◊ú◊ï◊ù ◊†◊©◊ú◊ó ◊ú◊ß◊ë◊ï◊¶◊î ◊ë◊î◊¶◊ú◊ó◊î!",
            description: "◊î◊ó◊ë◊®◊ô◊ù ◊ë◊ß◊ë◊ï◊¶◊î ◊ô◊õ◊ï◊ú◊ô◊ù ◊õ◊¢◊™ ◊ú◊¶◊§◊ï◊™ ◊ë◊ô◊î◊ú◊ï◊ù",
          });
          setShowConfirmDialog(false);
        } else {
          console.error('‚ùå SHARE DEBUG: Diamond sharing failed');
          impactOccurred('heavy');
          toast({
            title: "◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊ô◊î◊ú◊ï◊ù",
            description: "◊ê◊ô◊®◊¢◊î ◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊ô◊î◊ú◊ï◊ù ◊ú◊ß◊ë◊ï◊¶◊î",
            variant: "destructive"
          });
        }
      } else {
        console.error('‚ùå SHARE DEBUG: Share quota usage failed');
        impactOccurred('heavy');
        toast({
          title: "◊©◊í◊ô◊ê◊î ◊ë◊©◊ô◊û◊ï◊© ◊ë◊ó◊ú◊ß",
          description: "◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊î◊©◊™◊û◊© ◊ë◊ó◊ú◊ß ◊î◊†◊ï◊õ◊ó◊ô",
          variant: "destructive"
        });
      }
    } catch (error) {
      console.error('‚ùå SHARE DEBUG: Share process failed:', error);
      impactOccurred('heavy');
      toast({
        title: "◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊ô◊î◊ú◊ï◊ù",
        description: "◊ê◊ô◊®◊¢◊î ◊©◊í◊ô◊ê◊î ◊ú◊ê ◊¶◊§◊ï◊ô◊î",
        variant: "destructive"
      });
    }
  };

  const getButtonVariant = () => {
    if (!quotaData || quotaData.sharesRemaining <= 0) return "outline";
    if (quotaData.sharesRemaining <= 2) return "default";
    return variant;
  };

  const getButtonColor = () => {
    if (!quotaData || quotaData.sharesRemaining <= 0) return "bg-muted text-muted-foreground";
    if (quotaData.sharesRemaining <= 2) return "bg-amber-500 hover:bg-amber-600 text-white";
    return "bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white";
  };

  if (loading) {
    return (
      <Button variant="outline" size={size} disabled className={className}>
        <Share className="h-4 w-4 animate-pulse" />
        <span className="hidden sm:inline ml-2">Loading...</span>
      </Button>
    );
  }

  return (
    <Dialog open={showConfirmDialog} onOpenChange={setShowConfirmDialog}>
      <DialogTrigger asChild>
        <Button
          variant={getButtonVariant()}
          size={size}
          onClick={handleShareClick}
          disabled={!isAdmin && (!quotaData || quotaData.sharesRemaining <= 0)}
          className={`flex items-center gap-2 relative ${getButtonColor()} ${className}`}
        >
          {quotaData && quotaData.sharesRemaining <= 2 && quotaData.sharesRemaining > 0 && (
            <AlertTriangle className="h-3 w-3 animate-pulse" />
          )}
          {quotaData && quotaData.sharesRemaining > 2 && (
            <Sparkles className="h-4 w-4" />
          )}
          {(!quotaData || quotaData.sharesRemaining <= 0) && (
            <Share className="h-4 w-4 opacity-50" />
          )}
          {quotaData && quotaData.sharesRemaining > 0 && quotaData.sharesRemaining <= 2 && (
            <Share className="h-4 w-4" />
          )}
          <span className="hidden sm:inline">
            Share to Group
          </span>
          <Badge variant="secondary" className="ml-1 text-xs">
            {isAdmin ? "‚àû" : (quotaData?.sharesRemaining || 0)}
          </Badge>
        </Button>
      </DialogTrigger>
      
      <DialogContent className="w-[95vw] max-w-md mx-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2 text-lg">
            <Users className="h-5 w-5 text-purple-600" />
            Share to Telegram Group
          </DialogTitle>
          <p className="text-sm text-muted-foreground">
            Premium group sharing with analytics tracking
          </p>
        </DialogHeader>
        
        <div className="space-y-4 py-4">
          {/* Diamond Preview */}
          {diamond.imageUrl && (
            <div className="flex justify-center">
              <div className="relative rounded-lg overflow-hidden border border-border">
                <img 
                  src={diamond.imageUrl} 
                  alt={`${diamond.shape} diamond ${diamond.carat}ct`}
                  className="w-32 h-32 object-cover"
                />
                <div className="absolute top-2 right-2">
                  <Badge variant="secondary" className="text-xs">
                    <Camera className="h-3 w-3 mr-1" />
                    ◊™◊û◊ï◊†◊î
                  </Badge>
                </div>
              </div>
            </div>
          )}

          {/* Diamond Details */}
          <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200">
            <h4 className="font-semibold text-purple-800 mb-2 flex items-center gap-2">
              <Sparkles className="h-4 w-4" />
              ◊§◊®◊ò◊ô ◊î◊ô◊î◊ú◊ï◊ù ◊©◊ô◊©◊ú◊ó
            </h4>
            <div className="grid grid-cols-2 gap-2 text-sm text-purple-700">
              <div>üè∑Ô∏è <strong>{diamond.carat}</strong> ◊ß◊®◊ê◊ò</div>
              <div>üíé <strong>{diamond.shape}</strong></div>
              <div>üé® ◊¶◊ë◊¢ <strong>{diamond.color}</strong></div>
              <div>‚ú® ◊†◊ô◊ß◊ô◊ï◊ü <strong>{diamond.clarity}</strong></div>
              <div>‚ö° ◊ó◊ô◊™◊ï◊ö <strong>{diamond.cut}</strong></div>
              <div>üí∞ <strong>${diamond.price?.toLocaleString() || '◊¶◊ï◊® ◊ß◊©◊®'}</strong></div>
            </div>
          </div>

          {/* Quota Information */}
          {quotaData && (
            <div className="text-center space-y-2">
              <div className="text-2xl font-bold">
                {isAdmin ? "‚àû" : quotaData.sharesRemaining} ◊©◊ô◊™◊ï◊§◊ô◊ù ◊†◊ï◊™◊®◊ï
              </div>
              <div className="text-sm text-muted-foreground">
                {isAdmin ? "◊û◊†◊î◊ú - ◊©◊ô◊™◊ï◊§◊ô◊ù ◊ë◊ú◊™◊ô ◊û◊ï◊í◊ë◊ú◊ô◊ù" : `◊û◊™◊ï◊ö ${quotaData.sharesGranted} ◊©◊ô◊™◊ï◊§◊ô◊ù ◊õ◊ï◊ú◊ú`}
              </div>
            </div>
          )}

          <Alert>
            <AlertTriangle className="h-4 w-4" />
            <AlertDescription>
              <strong>◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ê◊™◊î ◊®◊ï◊¶◊î ◊ú◊î◊©◊™◊û◊© ◊ë◊©◊ô◊™◊ï◊£ ◊ê◊ó◊ì?</strong>
              <br />
              ◊ñ◊î ◊ô◊©◊ú◊ó ◊ê◊™ ◊õ◊®◊ò◊ô◊° ◊î◊ô◊î◊ú◊ï◊ù ◊ô◊©◊ô◊®◊ï◊™ ◊ú◊ß◊ë◊ï◊¶◊™ ◊î◊ò◊ú◊í◊®◊ù ◊©◊ú◊ö ◊¢◊ù ◊õ◊§◊™◊ï◊®◊ô◊ù ◊ê◊ô◊†◊ò◊®◊ê◊ß◊ò◊ô◊ë◊ô◊ô◊ù. 
              ◊ú◊ê◊ó◊® ◊î◊©◊ô◊û◊ï◊©, ◊ô◊ô◊©◊ê◊®◊ï ◊ú◊ö <strong>{isAdmin ? "‚àû" : (quotaData?.sharesRemaining || 1) - 1} ◊©◊ô◊™◊ï◊§◊ô◊ù</strong>.
            </AlertDescription>
          </Alert>

          <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200">
            <h4 className="font-semibold text-purple-800 mb-2">◊û◊î ◊ß◊ï◊®◊î ◊õ◊©◊ê◊™◊î ◊û◊©◊™◊£:</h4>
            <ul className="text-sm text-purple-700 space-y-1">
              <li>‚Ä¢ ◊õ◊®◊ò◊ô◊° ◊ô◊î◊ú◊ï◊ù ◊†◊©◊ú◊ó ◊ô◊©◊ô◊®◊ï◊™ ◊ú◊ß◊ë◊ï◊¶◊î</li>
              <li>‚Ä¢ {diamond.imageUrl ? "◊™◊û◊ï◊†◊™ ◊î◊ô◊î◊ú◊ï◊ù ◊™◊ï◊¶◊í ◊ë◊î◊ï◊ì◊¢◊î" : "◊î◊ï◊ì◊¢◊î ◊ò◊ß◊°◊ò◊ï◊ê◊ú◊ô◊™ ◊™◊ô◊©◊ú◊ó"}</li>
              <li>‚Ä¢ ◊®◊ß ◊û◊©◊™◊û◊©◊ô◊ù ◊®◊©◊ï◊û◊ô◊ù ◊ô◊õ◊ï◊ú◊ô◊ù ◊ú◊¶◊§◊ï◊™ ◊ë◊§◊®◊ò◊ô◊ù</li>
              <li>‚Ä¢ ◊ê◊™◊î ◊û◊ß◊ë◊ú ◊ê◊†◊ú◊ô◊ò◊ô◊ß◊î ◊¢◊ú ◊¶◊§◊ô◊ï◊™ ◊ï◊ê◊ô◊†◊ò◊®◊ê◊ß◊¶◊ô◊ï◊™</li>
              <li>‚Ä¢ ◊õ◊§◊™◊ï◊® ◊ô◊¶◊ô◊®◊™ ◊ß◊©◊® ◊û◊ê◊§◊©◊® ◊™◊ß◊©◊ï◊®◊™ ◊ô◊©◊ô◊®◊î</li>
              <li>‚Ä¢ ◊õ◊§◊™◊ï◊® ◊î◊¶◊¢◊™ ◊û◊ó◊ô◊®/◊ë◊ß◊©◊™ ◊î◊¶◊¢◊î ◊ñ◊û◊ô◊ü</li>
            </ul>
          </div>

          <div className="flex gap-2">
            <Button 
              variant="outline" 
              className="flex-1"
              onClick={() => setShowConfirmDialog(false)}
            >
              Cancel
            </Button>
            {isAdmin && (
              <Button 
                variant="outline"
                className="flex-1 border-blue-500 text-blue-500 hover:bg-blue-50"
                onClick={handleTestShare}
              >
                üß™ Test Message
              </Button>
            )}
            <Button 
              className="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600"
              onClick={handleConfirmShare}
            >
              <Sparkles className="h-4 w-4 mr-2" />
              Share Now
            </Button>
          </div>

          {quotaData && quotaData.sharesRemaining <= 2 && (
            <Alert>
              <AlertTriangle className="h-4 w-4" />
              <AlertDescription className="text-amber-700">
                <strong>Running low on shares!</strong> Contact admin to increase your quota.
              </AlertDescription>
            </Alert>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}