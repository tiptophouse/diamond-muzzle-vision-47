{
  "name": "AI Diamond Concierge",
  "nodes": [
    {
      "parameters": {
        "path": "ae74c72e-bb87-4235-a5a8-392b0c3ea291",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [0, 0],
      "id": "webhook-diamond-ai",
      "name": "Webhook - Diamond Request",
      "webhookId": "ae74c72e-bb87-4235-a5a8-392b0c3ea291"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=××ª×” ××•××—×” ×™×”×œ×•××™× ××§×¦×•×¢×™ ×”×¢×•×‘×“ ×¢× ×“×™×œ×¨×™× ×™×©×¨××œ×™×.\n\n×ª×¤×§×™×“×š:\n1. **×”×‘× ×ª ×”×‘×§×©×”**: × ×ª×— ×”×•×“×¢×•×ª ×‘×¢×‘×¨×™×ª/×× ×’×œ×™×ª ×œ×—×™×¤×•×© ×™×”×œ×•××™×\n2. **×—×™×œ×•×¥ ×§×¨×™×˜×¨×™×•× ×™×**: ×¦×•×¨×”, ××©×§×œ, ×¦×‘×¢, × ×™×§×™×•×Ÿ, ×—×™×ª×•×š, ××—×™×¨\n3. **×§×¨×™××ª MCP**: ×”×©×ª××© ×‘-tool search_diamonds\n4. **×”×—×–×¨×ª JSON**:\n\n×“×•×’××”:\n{{ $json.body.text }}\n\n×”×—×–×¨ JSON:\n{\n  \"found\": true/false,\n  \"count\": ××¡×¤×¨,\n  \"matches\": [\n    {\n      \"stock_number\": \"××—×¨×•×–×ª\",\n      \"shape\": \"×¦×•×¨×”\",\n      \"weight\": ××¡×¤×¨,\n      \"color\": \"×¦×‘×¢\",\n      \"clarity\": \"× ×™×§×™×•×Ÿ\",\n      \"cut\": \"×—×™×ª×•×š\",\n      \"price_per_carat\": ××¡×¤×¨,\n      \"total_price\": ××¡×¤×¨,\n      \"picture\": \"URL\",\n      \"seller_telegram_id\": ××¡×¤×¨\n    }\n  ]\n}",
        "options": {
          "systemMessage": "You are a professional diamond expert assistant for Israeli dealers. Parse Hebrew/English diamond search requests and extract criteria: shape, carat, color, clarity, cut, price range. Use MCP tools to search FastAPI inventory. Return structured JSON with top 3 matches or friendly Hebrew error message."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [220, 0],
      "id": "ai-agent",
      "name": "AI Agent - Diamond Search"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [220, 220],
      "id": "openai-model",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "fzFRCKvTfFUsRoCi",
          "name": "n8n free OpenAI API credits"
        }
      }
    },
    {
      "parameters": {
        "endpointUrl": "https://api.mazalbot.com/mcp",
        "serverTransport": "sse",
        "authentication": "bearerAuth",
        "options": {
          "timeout": 60000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1.2,
      "position": [420, 180],
      "id": "mcp-client",
      "name": "MCP Client - FastAPI",
      "credentials": {
        "httpBearerAuth": {
          "id": "V85KyIjoMEDG2U4F",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "mode": "load",
        "tableName": {
          "__rl": true,
          "value": "diamond_embeddings",
          "mode": "list"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [420, -20],
      "id": "vector-store",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "Rw8xqBBAxeNC546e",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [620, 180],
      "id": "embeddings",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "7IuyMm2U7mN4QQFP",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const agentOutput = $input.first().json.output || $input.first().json;\nconst webhook = $('Webhook - Diamond Request').item.json.body;\n\n// Parse AI response if it's a string\nlet parsedOutput;\ntry {\n  parsedOutput = typeof agentOutput === 'string' ? JSON.parse(agentOutput) : agentOutput;\n} catch (e) {\n  parsedOutput = { found: false, message: agentOutput };\n}\n\n// Check if diamonds found\nif (!parsedOutput.found || !parsedOutput.matches?.length) {\n  return [{\n    json: {\n      response_type: \"no_results\",\n      chat_id: webhook.chat_id,\n      message_id: webhook.message_id,\n      message: parsedOutput.message || \"×œ× × ××¦××• ×™×”×œ×•××™× ××ª××™××™× ×œ×—×™×¤×•×© ×©×œ×š ğŸ’\\n\\n× ×¡×”:\\nâ€¢ ×œ×”×¨×—×™×‘ ×˜×•×•×— ×”××—×™×¨×™×\\nâ€¢ ×œ×©× ×•×ª ×“×¨×’×ª × ×™×§×™×•×Ÿ/×¦×‘×¢\\nâ€¢ ×œ×—×¤×© ×¦×•×¨×•×ª ××—×¨×•×ª\"\n    }\n  }];\n}\n\n// Format matches for Telegram\nconst matches = parsedOutput.matches.slice(0, 3);\nconst formattedResults = matches.map(diamond => ({\n  stock_number: diamond.stock_number,\n  chat_id: webhook.chat_id,\n  caption: `ğŸ’ **×™×”×œ×•× ${diamond.shape}** - ${diamond.weight} ×§×¨×˜\\n\\n` +\n           `ğŸ¨ ×¦×‘×¢: ${diamond.color} | âœ¨ × ×™×§×™×•×Ÿ: ${diamond.clarity}\\n` +\n           `âœ‚ï¸ ×—×™×ª×•×š: ${diamond.cut}\\n\\n` +\n           `ğŸ’° **${diamond.total_price.toLocaleString('he-IL')} â‚ª**\\n` +\n           `(${diamond.price_per_carat.toLocaleString('he-IL')} â‚ª ×œ×§×¨×˜)\\n\\n` +\n           `ğŸ“¦ ××œ××™: ${diamond.stock_number}`,\n  photo: diamond.picture || 'https://via.placeholder.com/400x400?text=Diamond',\n  inline_keyboard: [\n    [\n      { text: \"ğŸ’ ×¤×¨×˜×™× ××œ××™×\", web_app: { url: `https://mazalbot.app/public/diamond/${diamond.stock_number}?from=ai_search` } },\n      { text: \"ğŸ“ ×¦×•×¨ ×§×©×¨\", web_app: { url: `https://mazalbot.app/contact/${diamond.seller_telegram_id}?diamond=${diamond.stock_number}` } }\n    ],\n    [\n      { text: \"ğŸ”— ×©×ª×£\", switch_inline_query: `diamond_${diamond.stock_number}` }\n    ]\n  ],\n  seller_telegram_id: diamond.seller_telegram_id\n}));\n\nreturn [{\n  json: {\n    response_type: \"results\",\n    count: matches.length,\n    results: formattedResults,\n    summary: `âœ… × ××¦××• ${parsedOutput.count} ×™×”×œ×•××™× ××ª××™××™×!\\n××¦×™×’ ××ª 3 ×”×˜×•×‘×™× ×‘×™×•×ª×¨:`,\n    analytics: {\n      telegram_group_id: webhook.chat_id,\n      telegram_user_id: webhook.from?.id,\n      query_text: webhook.text,\n      diamonds_matched: parsedOutput.count,\n      timestamp: new Date().toISOString()\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [640, 0],
      "id": "format-response",
      "name": "Format Response"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.response_type }}",
              "value2": "results"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [860, 0],
      "id": "check-results",
      "name": "Check Results"
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "telegramApi",
        "resource": "message",
        "operation": "sendMessage",
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "reply_to_message_id": "={{ $json.message_id }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1080, 200],
      "id": "send-no-results",
      "name": "Send No Results",
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot-credentials",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "results",
        "include": "selectedOtherFields",
        "fieldsToInclude": "analytics"
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [1080, -100],
      "id": "split-results",
      "name": "Split Results"
    },
    {
      "parameters": {
        "amount": 0.5,
        "unit": "seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1280, -100],
      "id": "throttle",
      "name": "Throttle Messages"
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "telegramApi",
        "resource": "message",
        "operation": "sendPhoto",
        "chatId": "={{ $json.chat_id }}",
        "binaryData": false,
        "photo": "={{ $json.photo }}",
        "additionalFields": {
          "caption": "={{ $json.caption }}",
          "parse_mode": "Markdown",
          "reply_markup": "inlineKeyboard",
          "inlineKeyboard": "={{ JSON.stringify({ inline_keyboard: $json.inline_keyboard }) }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1480, -100],
      "id": "send-diamond-cards",
      "name": "Send Diamond Cards",
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot-credentials",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const analytics = $('Format Response').item.json.analytics;\nconst startTime = new Date($('Webhook - Diamond Request').item.json.body.date * 1000);\n\nreturn [{\n  json: {\n    telegram_group_id: analytics.telegram_group_id,\n    telegram_id: analytics.telegram_user_id,\n    query_text: analytics.query_text,\n    diamonds_matched: analytics.diamonds_matched,\n    response_time_ms: Date.now() - startTime.getTime(),\n    user_clicked: false,\n    conversion_occurred: false,\n    metadata: {\n      workflow: 'ai_diamond_concierge',\n      n8n_execution_id: $execution.id\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1680, -100],
      "id": "prepare-analytics",
      "name": "Prepare Analytics"
    },
    {
      "parameters": {
        "operation": "insert",
        "tableId": "ai_concierge_analytics",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "telegram_group_id",
              "fieldValue": "={{ $json.telegram_group_id }}"
            },
            {
              "fieldId": "telegram_id",
              "fieldValue": "={{ $json.telegram_id }}"
            },
            {
              "fieldId": "query_text",
              "fieldValue": "={{ $json.query_text }}"
            },
            {
              "fieldId": "diamonds_matched",
              "fieldValue": "={{ $json.diamonds_matched }}"
            },
            {
              "fieldId": "response_time_ms",
              "fieldValue": "={{ $json.response_time_ms }}"
            },
            {
              "fieldId": "user_clicked",
              "fieldValue": "={{ $json.user_clicked }}"
            },
            {
              "fieldId": "conversion_occurred",
              "fieldValue": "={{ $json.conversion_occurred }}"
            },
            {
              "fieldId": "metadata",
              "fieldValue": "={{ JSON.stringify($json.metadata) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1880, -100],
      "id": "store-analytics",
      "name": "Store Analytics",
      "credentials": {
        "supabaseApi": {
          "id": "Rw8xqBBAxeNC546e",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"processed_by\": \"ai_diamond_concierge\", \"timestamp\": new Date().toISOString() } }}"
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [2080, 0],
      "id": "respond-webhook",
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "Webhook - Diamond Request": {
      "main": [
        [
          {
            "node": "AI Agent - Diamond Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Diamond Search": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Diamond Search",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "MCP Client - FastAPI": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Diamond Search",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "AI Agent - Diamond Search",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Check Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Results": {
      "main": [
        [
          {
            "node": "Split Results",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send No Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Results": {
      "main": [
        [
          {
            "node": "Throttle Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Throttle Messages": {
      "main": [
        [
          {
            "node": "Send Diamond Cards",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Diamond Cards": {
      "main": [
        [
          {
            "node": "Prepare Analytics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Analytics": {
      "main": [
        [
          {
            "node": "Store Analytics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Analytics": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send No Results": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {}
}